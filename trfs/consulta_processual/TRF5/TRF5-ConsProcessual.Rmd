---
title: "TRF5-ConsProcessual"
output: html_notebook
---

```{r}
#library(RSelenium)
library(rvest)
library(dplyr)
library(httr)
library(decryptr)
library(data.table)
```

```{r}
# exemplos para construcao do scrapper
## 00014068420174050000
## 200683000106242
## 200405000360589

query <- "00014068420174050000"

path <- "/home/nathang/Documentos/Scripts and Documents/ESTAGIO_ABJ/ABJ/trfs/consulta_processual/TRF5/data-raw/"

obter_ConsTRF5 <- function(query, path){
  url <- "http://www.trf5.jus.br/cp/cp.do"
  query_GET <- list("filtro"=query,
                   "tipo" = "xmlproc",
                   "navigation" = "Netscape",
                   "vinculados"="true",
                   "ordenacao" = "D",
                   "tipoproc" = "T",
                   "ordenacao+cpf"="D")
  proc <- stringr::str_replace_all(query, "[[:punct:]]", "") %>% 
    stringr::str_c(.,".html")
  dir.create(path, FALSE, TRUE)
  path <- normalizePath(path)
  file <- stringr::str_c(path, "/")
  PathFile <- stringr::str_c(file, proc)
  
  httr::POST(url, query = query_GET, 
             httr::config(ssl_verifypeer = FALSE),
             write_disk(PathFile, overwrite = T)) 
}
obter_ConsTRF5(query, path)
```

```{r}
file <- dir(path = "data-raw/", full.names = T)

# Obtendo os nodes
node <- file[1] %>% read_html()

# Movimentacao
mov_node <- node %>%
  html_table(fill = T) %>% 
  .[6:length(.)]

movimentacao <- mov_node %>% 
  purrr::map_dfc(~select_(.x , .x %>% colnames() %>% dplyr::last())) %>% 
  data.table::transpose() %>% {
    if(ncol(.) == 3 ){
      magrittr::set_names(., c("data", "mov", "detalhe"))
    } else if (ncol(.) == 2){
      magrittr::set_names(., c("data", "mov"))
    }
  } %>% 
  mutate(data = stringr::str_replace_all(data, "[E-e]m", ""),
         data = stringr::str_trim(data)) %>% 
  tidyr::separate(data, c("data", "hora"), sep = " ")

# Informacoes gerais
proc <- node %>% html_node(xpath = '/html/body/p[2]') %>% html_text() %>% stringr::str_replace_all("[^0-9]", "")

info_node <- node %>%
  html_table(fill = T) %>% 
  .[1:5]

info_1 <- info_node %>% purrr::pluck(1) %>% select_(., colnames(.) %>% dplyr::first()) %>% 
  magrittr::set_names("key") %>% 
  tidyr::separate(key, c("key", "val"), sep = ":") %>% 
  mutate(key = stringr::str_to_lower(key),
         key = stringr::str_replace_all(key, "[[:punct:]]",""),
         key = abjutils::rm_accent(key),
         key = stringr::str_replace_all(key, " +", "_"))

info_2 <- info_node %>% purrr::pluck(3) %>% 
  magrittr::set_names(c("key", "val")) %>% 
  mutate(key = stringr::str_to_lower(key),
         key = stringr::str_replace_all(key, "[[:punct:]]",""),
         key = abjutils::rm_accent(key),
         key = stringr::str_replace_all(key, " +", "_"),
         val = stringr::str_replace_all(val, ":|\\t", "")) %>% 
  tidyr::spread(key, val)
```

