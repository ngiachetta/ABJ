---
title: "DJE-Justica Federal da Terceira Regiao"
output: html_notebook
---
```{r message=F, warning=FALSE}
library(httr)
library(rvest)
library(dplyr)
library(purrr)
```

```{r}
# Obtendo a primeira pagina
url <- "http://web.trf3.jus.br/diario/Consulta/ResultadoPesquisa/"

url_1 <- stringr::str_c(url, "1")

query <- list(
  "FiltroPesquisaPublicacao.CodigoOrgao"=2,	# 2 eh SJSP
  "FiltroPesquisaPublicacao.CodigoTipoPublicacao"=1, # Vai de 1 a 9
  "FiltroPesquisaPublicacao.CodigoUnidade"="",	
  "FiltroPesquisaPublicacao.DataFinal"="13/03/2018",
  "FiltroPesquisaPublicacao.DataInicial"="13/03/2018",
  "FiltroPesquisaPublicacao.DocumentosPagina"="100",
  "FiltroPesquisaPublicacao.IdSerie"="",	
  "FiltroPesquisaPublicacao.NomeLocalidade"="",
  "FiltroPesquisaPublicacao.NumeroOab"="",
  "FiltroPesquisaPublicacao.NumeroProcesso"=""
)

path <- "data-raw/"
dir.create(path, FALSE, TRUE)
path <- normalizePath(path)
file <- stringr::str_c(path, "/page1.html")
request_POST <- function(url, query = NULL, file){
  if(is.null(query)){
    request <- httr::POST(url, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))
  }else{
    request <- httr::POST(url,body = query, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))    
  }

  return(request)
}
request <- request_POST(url_1, query = query,file = file)

node <- request %>% xml2::read_html()

total_pag <- node %>% html_node(xpath = '//form/label') %>% html_text() %>% stringr::str_extract("[0-9]+$") %>% as.numeric()

qnt_percorrer <- 2:ceiling(total_pag/100)

urls <- list()
files <- list()
for(i in 1:length(qnt_percorrer)){
  urls[[i]] <- stringr::str_c(url, qnt_percorrer[i])
  files[[i]] <- stringr::str_c(path, "/page", qnt_percorrer[i], ".html")
}

request_POST(urls[[1]], file = files[[1]], query = query)

# purrr::map(urls,files, ~request_POST(.x, file = .y))
# request_POST(urls[[1]], file = files[[1]])
# 
# node %>% html_table(fill = T)
# tibble(link_diario = node %>%
#          html_nodes(xpath = '//td[@class="alinhamento"]/a') %>%
#          html_attr("href") %>% 
#          stringr::str_c("http://web.trf3.jus.br",.))

```

```{r}
session <- rvest::html_session(url_1)

session %>% rvest:::request_POST(url_1,httr::config(referer = .$url), body = query, httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))
```

