---
title: "DJE-Justica Federal da Terceira Regiao"
output: html_notebook
---
```{r message=F, warning=FALSE}
library(httr)
library(rvest)
library(dplyr)
library(purrr)
```

```{r}
# Obtendo a primeira pagina
url <- "http://web.trf3.jus.br/diario/Consulta/ResultadoPesquisa/"

url_1 <- stringr::str_c(url, "1")

query <- list(
  "FiltroPesquisaPublicacao.CodigoOrgao"=2,	# 2 eh SJSP
  "FiltroPesquisaPublicacao.CodigoTipoPublicacao"=1, # Vai de 1 a 9
  "FiltroPesquisaPublicacao.CodigoUnidade"="",
  "FiltroPesquisaPublicacao.DataInicial"="10/04/2011",
  "FiltroPesquisaPublicacao.DataFinal"="16/05/2011",
  "FiltroPesquisaPublicacao.DocumentosPagina"="100",
  "FiltroPesquisaPublicacao.IdSerie"="",	
  "FiltroPesquisaPublicacao.NomeLocalidade"="",
  "FiltroPesquisaPublicacao.NumeroOab"="",
  "FiltroPesquisaPublicacao.NumeroProcesso"=""
)

path <- "data-raw/"
dir.create(path, FALSE, TRUE)
path <- normalizePath(path)
file <- stringr::str_c(path, "/page1.html")
request_POST_GET <- function(method = "POST", url, query = NULL, file){
  if (is.null(query) == T & method == "POST"){
    request <- httr::POST(url, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))
  }else if( is.null(query) == F & method == "POST"){
    request <- httr::POST(url, body = query, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))    
  }else if (is.null(query) == T & method == "GET"){
    request <- httr::GET(url, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))
  }else {
    request <- httr::GET(url, query = query, 
           httr::config(ssl_verifypeer = FALSE),
           httr::write_disk(file, TRUE))  
  }

  return(request)
}
request <- request_POST_GET(method = "POST", url_1, query = query,file = file)

node <- request %>% xml2::read_html()

total_pag <- node %>% html_node(xpath = '//form/label') %>% html_text() %>% stringr::str_extract("[0-9]+$") %>% as.numeric()

qnt_percorrer <- 2:ceiling(total_pag/100)

urls <- list()
files <- list()
for(i in 1:length(qnt_percorrer)){
  urls[[i]] <- stringr::str_c(url, qnt_percorrer[i])
  files[[i]] <- stringr::str_c(path, "/page", qnt_percorrer[i], ".html")
}


purrr::map2(urls, files,~request_POST_GET(method = "GET", .x, file = .y, query = query))

files_path <- dir(path = "data-raw/", pattern = "page", full.names = T)


parse_file <- function(file){
  node_file <- file %>% xml2::read_html()

  tabela <- node_file %>% html_table(fill = T) %>% purrr::pluck(1) %>% {
    if(ncol(.) == 6){
      magrittr::set_names(.,c("vazio", "data_disponibilizacao", "orgao", "unidade", "tipo_publicacao", "doc_publ"))
    }
  } %>% 
  dplyr::select(-doc_publ, -vazio)
  link_diario <- tibble(link_diario = node_file %>%
           html_nodes(xpath = '//td[@class="alinhamento"]/a') %>%
           html_attr("href") %>%
           stringr::str_c("http://web.trf3.jus.br",.))
  tabela <- dplyr::bind_cols(tabela, link_diario) %>% dplyr::mutate(file = file)
  return(tabela)
}

tabela <- map_dfr(files_path, ~parse_file(.x))
```