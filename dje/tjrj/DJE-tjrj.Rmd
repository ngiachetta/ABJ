---
title: "DJE-TJRJ"
output: html_notebook
---

```{r}
library(httr)
library(rvest)
library(dplyr)
library(purrr)
library(stringr)
```

```{r}
qntd_paginas <- function(caderno = "A", dtPub){
  url_qntd_paginas <- "https://www3.tjrj.jus.br/consultadje/caderno.asmx/ConsultarQuantidadePaginas"  
  query_post <- list(
    "codCaderno"=caderno,
    "dtPub"=dtPub
  )
  request_qntd_pg <- httr::POST(url_qntd_paginas,
                                body = query_post,
                                httr::config(ssl_verifypeer = FALSE),
                                encode = "json")

  num_paginas <- request_qntd_pg %>% 
    httr::content() %>% 
    unlist() %>% 
    as.numeric() %>% 
    seq(1, ., 1)
  
  return(num_paginas)
}
#qntd_paginas(caderno = "S", dtPub = "09/03/2018")

# eh preciso obter o _dc mas esta dificil
# url_0 <- "https://www3.tjrj.jus.br/consultadje/consultaDJE.aspx"
# 
# date_string <- "14/03/2018"
# caderno <- "A"
# pagina <- -1
# 
# query_0 <- list(
#   "dtPub"=date_string,
#   "caderno"=caderno,
#   "pagina"=pagina
#   )
# 
# request_0 <- httr::GET(url_0, query = query_0, httr::config(ssl_verifypeer = FALSE),
#                        handle = httr::handle("https://www3.tjrj.jus.br/consultadje/consultaDiario.aspx?dtPub=14/03/2018&caderno=A&pagina=-1&pesquisa=&intranet=N&_dc=1522709860256"))
# request_0$url %>% 
#   rvest::html_session(httr::config(ssl_verifypeer = FALSE)) %>% 
#   rvest::html_form()

# request_0 %>% httr::content() %>% 
#   rvest::html_nodes(xpath = '//form') %>% 
#   rvest::html_attr("action") %>% 
#   stringr::str_replace_all("^.", "") %>% 
#   stringr::str_c("https://www3.tjrj.jus.br/consultadje", .) %>% 
#   httr::POST(httr::config(ssl_verifypeer = FALSE)) %>% 
#   httr::content() %>% 
#   rvest::html_nodes(xpath = '//iframe')

obter_linkPDF <- function(date_string, caderno, pagina, dc = 1522675292694){
  
  query_1 <- list(
  "dtPub"=date_string,
  "caderno"=caderno,
  "pagina"=pagina,
  "_dc"=dc
  )
  # url_download eh um link que direciona para o link do pdf sem precisar passar pelo captcha
  url_download <- "https://www3.tjrj.jus.br/consultadje/pdf.aspx"

  request <- httr::GET(url_download, query = query_1, httr::config(ssl_verifypeer = FALSE))  
  
  return(request$url)
}

#obter_linkPDF(date_string = "09/03/2018", caderno = "S", pagina = 1, dc = 1522710519786)
# Quando o arquivo nÃ£o existe volta uma url sem a query GEDID

linkPDF <- function(date_string = "09/03/2018", caderno = "S", dc = 1522710519786){
  
  paginas <- qntd_paginas(caderno = caderno, dtPub = date_string)
  
  links <- purrr::map_chr(paginas, ~obter_linkPDF(date_string = date_string, caderno = caderno, pagina = .x, dc = dc))
  
  lista_links <- list(date_string = links)
  
  return(lista_links)
}
datas <- c("06/03/2018", "07/03/2018")

teste <- purrr::map(datas, ~linkPDF(date_string = .x))

teste <- linkPDF()

head(oi)
```

