---
title: "TJAL-ConsProcessual"
author: "Nathan Giachetta"
output: html_document
---

# TJAL: Consulta Processual

```{r}
library(rvest)
library(dplyr)
library(stringr)
library(httr)
library(purrr)
```

```{r}
d_cjsg <- readr::read_rds("/home/nathang/Documentos/Scripts and Documents/ESTAGIO_ABJ/ABJ/tjs/jurisprudencia/TJAL/data-raw_al/data_rds/d_cjsg.rds")

processos <- unique(d_cjsg$id_lawsuit) %>%
  na.omit() 
path <- "/home/nathang/Documentos/Scripts and Documents/ESTAGIO_ABJ/ABJ/tjs/consulta_processual/TJAL/data-raw_AL/d_cposg/"

obter_proc <-function(query, path){
  url <- "https://www2.tjal.jus.br/cposg5/search.do"
  
  # Preenchendo o formulÃ¡rio
  query_GET <- list(`conversationId`="",
                    `cbPesquisa`="NUMPROC",
                    `tipoNuProcesso`="UNIFICADO",
                    `dePesquisaNuUnificado` = query,
                    `uuidCaptcha`="",
                    `chNmCompleto`="true",
                    `pbEnviar`="Pesquisar")

  proc <- stringr::str_replace_all(query, "[[:punct:]]", "") %>% 
    stringr::str_c(.,".html")
  dir.create(path, FALSE, TRUE)
  path <- normalizePath(path)
  file <- stringr::str_c(path, "/")
  PathFile <- stringr::str_c(file, proc)
  httr::GET(url, query = query_GET,
            httr::config(ssl_verifypeer = FALSE),
            write_disk(PathFile, overwrite = T))
}

purrr::map(processos , ~obter_proc(.x, path))
```

```{r}
# Parseando CPOSG
files_cposg <- dir("/home/nathang/Documentos/Scripts and Documents/ESTAGIO_ABJ/ABJ/tjs/consulta_processual/TJAL/data-raw_AL/d_cposg/", full.names = TRUE)

node <- xml2::read_html(files_cposg[1], enconding = "UTF-8")

# MOVIMENTACAO
parse_mov <- function(node){
 mov <- node %>% rvest::html_nodes('#tabelaTodasMovimentacoes')

 mov <- mov %>% 
   html_nodes(xpath = '//tr[@class="fundoClaro"]|//tr[@class="fundoEscuro"]') %>%
   html_text() %>%
   stringr::str_trim() %>%
   stringr::str_replace("\\n", "quebralinhaaqui") %>%
   as_tibble()  %>%
   tidyr::separate(value, into= c("data", "movimento"), sep = "(quebralinhaaqui)") %>%
   tidyr::drop_na()
 
  mov <- mov[stringr::str_detect(mov$data, "[0-9]"),]  
}

# DADOS DO PROCESSO

# prc <- node %>% rvest::html_nodes('.labelClass') %>% html_text()

prc <- node %>%
  rvest::html_nodes('.secaoFormBody') %>%
  rvest::html_table(fill = T) %>% 
  dplyr::last()
```

